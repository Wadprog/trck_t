service: finance-tracker-backend

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    COGNITO_USER_POOL_ID: 
      Ref: CognitoUserPool
    COGNITO_USER_POOL_CLIENT_ID:
      Ref: CognitoUserPoolClient
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - rds:DescribeDBInstances
            - rds:DescribeDBClusters
            - secretsmanager:GetSecretValue
            - secretsmanager:DescribeSecret
          Resource: '*'

functions:
  # Categories Functions
  getCategories:
    handler: src/resolvers/categories-simple.getCategories
    vpc:
      securityGroupIds:
        - !Ref LambdaSecurityGroup
      subnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    environment:
      DB_HOST: !GetAtt DatabaseInstance.Endpoint.Address
      DB_PORT: !GetAtt DatabaseInstance.Endpoint.Port
      DB_NAME: financetracker
      DB_SECRET_ARN: !Ref DatabaseSecret

  getCategory:
    handler: src/resolvers/categories-simple.getCategory
    vpc:
      securityGroupIds:
        - !Ref LambdaSecurityGroup
      subnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    environment:
      DB_HOST: !GetAtt DatabaseInstance.Endpoint.Address
      DB_PORT: !GetAtt DatabaseInstance.Endpoint.Port
      DB_NAME: financetracker
      DB_SECRET_ARN: !Ref DatabaseSecret

  createCategory:
    handler: src/resolvers/categories-simple.createCategory
    vpc:
      securityGroupIds:
        - !Ref LambdaSecurityGroup
      subnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    environment:
      DB_HOST: !GetAtt DatabaseInstance.Endpoint.Address
      DB_PORT: !GetAtt DatabaseInstance.Endpoint.Port
      DB_NAME: financetracker
      DB_SECRET_ARN: !Ref DatabaseSecret

  updateCategory:
    handler: src/resolvers/categories-simple.updateCategory
    vpc:
      securityGroupIds:
        - !Ref LambdaSecurityGroup
      subnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    environment:
      DB_HOST: !GetAtt DatabaseInstance.Endpoint.Address
      DB_PORT: !GetAtt DatabaseInstance.Endpoint.Port
      DB_NAME: financetracker
      DB_SECRET_ARN: !Ref DatabaseSecret

  deleteCategory:
    handler: src/resolvers/categories-simple.deleteCategory
    vpc:
      securityGroupIds:
        - !Ref LambdaSecurityGroup
      subnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
    environment:
      DB_HOST: !GetAtt DatabaseInstance.Endpoint.Address
      DB_PORT: !GetAtt DatabaseInstance.Endpoint.Port
      DB_NAME: financetracker
      DB_SECRET_ARN: !Ref DatabaseSecret

resources:
  - ${file(resources/cognito.yml)}
  - ${file(resources/database-clean.yml)}
  - ${file(resources/appsync.yml)}
  - Outputs:
      GraphQLApiEndpoint:
        Description: "AppSync GraphQL API Endpoint"
        Value: !GetAtt AppSyncApi.GraphQLUrl
        
      GraphQLApiId:
        Description: "AppSync GraphQL API ID"
        Value: !Ref AppSyncApi
        
      GraphQLApiKey:
        Description: "AppSync GraphQL API Key"
        Value: !GetAtt AppSyncApiKey.ApiKey
        
      CognitoUserPoolId:
        Description: "Cognito User Pool ID"
        Value: !Ref CognitoUserPool
        
      CognitoUserPoolClientId:
        Description: "Cognito User Pool Client ID"
        Value: !Ref CognitoUserPoolClient
        
      DatabaseEndpoint:
        Description: "RDS Database Endpoint"
        Value: !GetAtt DatabaseInstance.Endpoint.Address
        
      DatabasePort:
        Description: "RDS Database Port"
        Value: !GetAtt DatabaseInstance.Endpoint.Port
        
      DatabaseName:
        Description: "RDS Database Name"
        Value: financetracker
        
      DatabaseSecretArn:
        Description: "RDS Database Secret ARN"
        Value: !Ref DatabaseSecret
