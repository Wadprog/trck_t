service: finance-tracker-backend

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}

plugins:
  - serverless-appsync-plugin

custom:
  appSync:
    - name: finance-tracker-api-${self:provider.stage}
      authenticationType: API_KEY
      schema: schema.graphql
      mappingTemplatesLocation: mapping-templates
      mappingTemplates:
        - dataSource: TransactionsTable
          type: Query
          field: getTransactions
          request: get-transactions-request.vtl
          response: get-transactions-response.vtl
        - dataSource: TransactionsTable
          type: Mutation
          field: addTransaction
          request: add-transaction-request.vtl
          response: add-transaction-response.vtl
      dataSources:
        - type: AMAZON_DYNAMODB
          name: TransactionsTable
          description: "Transaction records"
          config:
            tableName: !Ref TransactionsTable

resources:
  Resources:
    TransactionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: TransactionsTable-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH

  Outputs:
    TransactionsTableName:
      Description: "DynamoDB table for transactions"
      Value: !Ref TransactionsTable
    AppSyncAPIURL:
      Description: "AppSync GraphQL API endpoint"
      Value:
        Fn::GetAtt:
          - GraphQlApi
          - GraphQLUrl
